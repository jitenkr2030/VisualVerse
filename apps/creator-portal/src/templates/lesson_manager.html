{% extends "base.html" %}

{% block title %}Lesson Manager - VisualVerse{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-12">
            <div class="page-header d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1><i class="fas fa-book me-2"></i>My Lessons</h1>
                    <p class="text-muted">Manage and organize your created lessons</p>
                </div>
                <div>
                    <a href="/lesson-creator" class="btn btn-primary">
                        <i class="fas fa-plus me-2"></i>Create New Lesson
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters and Search -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="row g-3 align-items-end">
                        <div class="col-md-3">
                            <label for="searchInput" class="form-label">Search Lessons</label>
                            <input type="text" class="form-control" id="searchInput" 
                                   placeholder="Search by title or subject...">
                        </div>
                        <div class="col-md-2">
                            <label for="subjectFilter" class="form-label">Subject</label>
                            <select class="form-select" id="subjectFilter">
                                <option value="">All Subjects</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="statusFilter" class="form-label">Status</label>
                            <select class="form-select" id="statusFilter">
                                <option value="">All Status</option>
                                <option value="draft">Draft</option>
                                <option value="processing">Processing</option>
                                <option value="completed">Completed</option>
                                <option value="error">Error</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="sortBy" class="form-label">Sort By</label>
                            <select class="form-select" id="sortBy">
                                <option value="created_at">Created Date</option>
                                <option value="title">Title</option>
                                <option value="subject">Subject</option>
                                <option value="status">Status</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="sortOrder" class="form-label">Order</label>
                            <select class="form-select" id="sortOrder">
                                <option value="desc">Descending</option>
                                <option value="asc">Ascending</option>
                            </select>
                        </div>
                        <div class="col-md-1">
                            <button class="btn btn-outline-secondary w-100" onclick="clearFilters()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Lessons Grid -->
    <div class="row">
        <div class="col-12">
            <div id="lessonsContainer">
                <div class="text-center py-5">
                    <i class="fas fa-spinner fa-spin fa-3x text-muted mb-3"></i>
                    <p class="text-muted">Loading lessons...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Lesson Details Modal -->
<div class="modal fade" id="lessonDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-info-circle me-2"></i>Lesson Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="lessonDetailsBody">
                <!-- Lesson details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="editLessonBtn">
                    <i class="fas fa-edit me-2"></i>Edit Lesson
                </button>
                <button type="button" class="btn btn-success" id="downloadLessonBtn">
                    <i class="fas fa-download me-2"></i>Download
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle text-warning me-2"></i>Confirm Delete
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this lesson? This action cannot be undone.</p>
                <p><strong id="deleteLessonTitle"></strong></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                    <i class="fas fa-trash me-2"></i>Delete Lesson
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Actions Modal -->
<div class="modal fade" id="bulkActionsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-tasks me-2"></i>Bulk Actions
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Select lessons and choose an action:</p>
                <div class="list-group" id="selectedLessonsList">
                    <!-- Selected lessons will be listed here -->
                </div>
                <hr>
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-danger" onclick="bulkDelete()">
                        <i class="fas fa-trash me-2"></i>Delete Selected
                    </button>
                    <button class="btn btn-outline-info" onclick="bulkExport()">
                        <i class="fas fa-download me-2"></i>Export Selected
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let allLessons = [];
let filteredLessons = [];
let selectedLessons = new Set();
let currentLessonId = null;

document.addEventListener('DOMContentLoaded', function() {
    loadLessons();
    loadSubjects();
    initializeEventListeners();
    setupAutoRefresh();
});

function initializeEventListeners() {
    // Search and filter
    document.getElementById('searchInput').addEventListener('input', applyFilters);
    document.getElementById('subjectFilter').addEventListener('change', applyFilters);
    document.getElementById('statusFilter').addEventListener('change', applyFilters);
    document.getElementById('sortBy').addEventListener('change', applyFilters);
    document.getElementById('sortOrder').addEventListener('change', applyFilters);
    
    // Delete confirmation
    document.getElementById('confirmDeleteBtn').addEventListener('click', confirmDeleteLesson);
}

function loadSubjects() {
    fetch('/api/subjects')
        .then(response => response.json())
        .then(data => {
            const select = document.getElementById('subjectFilter');
            data.subjects.forEach(subject => {
                const option = document.createElement('option');
                option.value = subject.id;
                option.textContent = subject.name;
                select.appendChild(option);
            });
        })
        .catch(error => console.error('Error loading subjects:', error));
}

function loadLessons() {
    fetch('/api/lessons')
        .then(response => response.json())
        .then(data => {
            allLessons = data.lessons;
            applyFilters();
        })
        .catch(error => {
            console.error('Error loading lessons:', error);
            showNotification('Error loading lessons', 'error');
            renderEmptyState();
        });
}

function applyFilters() {
    let filtered = [...allLessons];
    
    // Search filter
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    if (searchTerm) {
        filtered = filtered.filter(lesson => 
            lesson.title.toLowerCase().includes(searchTerm) ||
            lesson.subject.toLowerCase().includes(searchTerm)
        );
    }
    
    // Subject filter
    const subjectFilter = document.getElementById('subjectFilter').value;
    if (subjectFilter) {
        filtered = filtered.filter(lesson => lesson.subject === subjectFilter);
    }
    
    // Status filter
    const statusFilter = document.getElementById('statusFilter').value;
    if (statusFilter) {
        filtered = filtered.filter(lesson => lesson.status === statusFilter);
    }
    
    // Sort
    const sortBy = document.getElementById('sortBy').value;
    const sortOrder = document.getElementById('sortOrder').value;
    
    filtered.sort((a, b) => {
        let aVal = a[sortBy];
        let bVal = b[sortBy];
        
        if (sortBy === 'created_at') {
            aVal = new Date(aVal);
            bVal = new Date(bVal);
        }
        
        if (sortOrder === 'asc') {
            return aVal > bVal ? 1 : -1;
        } else {
            return aVal < bVal ? 1 : -1;
        }
    });
    
    filteredLessons = filtered;
    renderLessons();
}

function renderLessons() {
    const container = document.getElementById('lessonsContainer');
    
    if (filteredLessons.length === 0) {
        renderEmptyState();
        return;
    }
    
    const lessonsHtml = `
        <div class="row g-3">
            ${filteredLessons.map(lesson => `
                <div class="col-lg-4 col-md-6">
                    <div class="card lesson-card h-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <div class="form-check">
                                <input class="form-check-input lesson-checkbox" type="checkbox" 
                                       value="${lesson.id}" onchange="toggleLessonSelection(this)">
                            </div>
                            <span class="badge bg-${getStatusColor(lesson.status)}">${lesson.status}</span>
                        </div>
                        <div class="card-body">
                            <h5 class="card-title">${lesson.title}</h5>
                            <p class="card-text">
                                <i class="fas fa-book me-1"></i>${lesson.subject}
                                <br>
                                <i class="fas fa-calendar me-1"></i>${formatDate(lesson.created_at)}
                            </p>
                            <div class="d-flex gap-2">
                                <button class="btn btn-sm btn-outline-primary" onclick="viewLessonDetails('${lesson.id}')">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="editLesson('${lesson.id}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-success" onclick="downloadLesson('${lesson.id}')">
                                    <i class="fas fa-download"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteLesson('${lesson.id}', '${lesson.title}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('')}
        </div>
        
        ${filteredLessons.length > 0 ? `
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>${filteredLessons.length}</strong> lesson(s) found
                                    ${selectedLessons.size > 0 ? `
                                        <span class="ms-2">
                                            <strong>${selectedLessons.size}</strong> selected
                                        </span>
                                    ` : ''}
                                </div>
                                ${selectedLessons.size > 0 ? `
                                    <button class="btn btn-outline-primary" onclick="showBulkActions()">
                                        <i class="fas fa-tasks me-2"></i>Bulk Actions
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        ` : ''}
    `;
    
    container.innerHTML = lessonsHtml;
}

function renderEmptyState() {
    const container = document.getElementById('lessonsContainer');
    container.innerHTML = `
        <div class="text-center py-5">
            <i class="fas fa-book-open fa-3x text-muted mb-3"></i>
            <h4 class="text-muted">No lessons found</h4>
            <p class="text-muted">Create your first lesson to get started!</p>
            <a href="/lesson-creator" class="btn btn-primary">
                <i class="fas fa-plus me-2"></i>Create New Lesson
            </a>
        </div>
    `;
}

function clearFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('subjectFilter').value = '';
    document.getElementById('statusFilter').value = '';
    document.getElementById('sortBy').value = 'created_at';
    document.getElementById('sortOrder').value = 'desc';
    applyFilters();
}

function toggleLessonSelection(checkbox) {
    const lessonId = checkbox.value;
    if (checkbox.checked) {
        selectedLessons.add(lessonId);
    } else {
        selectedLessons.delete(lessonId);
    }
}

function viewLessonDetails(lessonId) {
    currentLessonId = lessonId;
    fetch(`/api/lessons/${lessonId}`)
        .then(response => response.json())
        .then(data => {
            const lesson = data.lesson;
            const modalBody = document.getElementById('lessonDetailsBody');
            
            modalBody.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Lesson Information</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Title:</strong></td><td>${lesson.title}</td></tr>
                            <tr><td><strong>Subject:</strong></td><td>${lesson.subject}</td></tr>
                            <tr><td><strong>Status:</strong></td><td><span class="badge bg-${getStatusColor(lesson.status)}">${lesson.status}</span></td></tr>
                            <tr><td><strong>Created:</strong></td><td>${formatDate(lesson.created_at)}</td></tr>
                            ${lesson.updated_at ? `<tr><td><strong>Updated:</strong></td><td>${formatDate(lesson.updated_at)}</td></tr>` : ''}
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>Content Preview</h6>
                        <div class="content-preview">
                            ${lesson.content.substring(0, 200)}${lesson.content.length > 200 ? '...' : ''}
                        </div>
                    </div>
                </div>
            `;
            
            // Set up action buttons
            document.getElementById('editLessonBtn').onclick = () => editLesson(lessonId);
            document.getElementById('downloadLessonBtn').onclick = () => downloadLesson(lessonId);
            
            const modal = new bootstrap.Modal(document.getElementById('lessonDetailsModal'));
            modal.show();
        })
        .catch(error => {
            console.error('Error loading lesson details:', error);
            showNotification('Error loading lesson details', 'error');
        });
}

function editLesson(lessonId) {
    // Redirect to lesson creator with lesson data
    window.location.href = `/lesson-creator?edit=${lessonId}`;
}

function downloadLesson(lessonId) {
    // Implementation for lesson download
    showNotification('Download feature coming soon', 'info');
}

function deleteLesson(lessonId, lessonTitle) {
    currentLessonId = lessonId;
    document.getElementById('deleteLessonTitle').textContent = lessonTitle;
    const modal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
    modal.show();
}

function confirmDeleteLesson() {
    if (!currentLessonId) return;
    
    fetch(`/api/lessons/${currentLessonId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Lesson deleted successfully', 'success');
            loadLessons(); // Refresh lessons list
            const modal = bootstrap.Modal.getInstance(document.getElementById('deleteConfirmModal'));
            modal.hide();
        } else {
            throw new Error(data.error || 'Failed to delete lesson');
        }
    })
    .catch(error => {
        console.error('Error deleting lesson:', error);
        showNotification('Error deleting lesson', 'error');
    });
}

function showBulkActions() {
    const selectedList = document.getElementById('selectedLessonsList');
    const selectedLessonsArray = allLessons.filter(lesson => selectedLessons.has(lesson.id));
    
    selectedList.innerHTML = selectedLessonsArray.map(lesson => `
        <div class="list-group-item d-flex justify-content-between align-items-center">
            <div>
                <h6 class="mb-1">${lesson.title}</h6>
                <small class="text-muted">${lesson.subject} â€¢ ${formatDate(lesson.created_at)}</small>
            </div>
            <span class="badge bg-${getStatusColor(lesson.status)}">${lesson.status}</span>
        </div>
    `).join('');
    
    const modal = new bootstrap.Modal(document.getElementById('bulkActionsModal'));
    modal.show();
}

function bulkDelete() {
    // Implementation for bulk delete
    showNotification('Bulk delete feature coming soon', 'info');
}

function bulkExport() {
    // Implementation for bulk export
    showNotification('Bulk export feature coming soon', 'info');
}

function setupAutoRefresh() {
    // Refresh lessons every 30 seconds
    setInterval(loadLessons, 30000);
}

function formatDate(dateString) {
    return new Date(dateString).toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

function getStatusColor(status) {
    switch(status) {
        case 'completed': return 'success';
        case 'processing': return 'info';
        case 'error': return 'danger';
        case 'draft': return 'secondary';
        default: return 'secondary';
    }
}

function showNotification(message, type = 'info') {
    const toast = document.getElementById('notificationToast');
    const toastMessage = document.getElementById('toastMessage');
    
    toastMessage.textContent = message;
    toast.className = `toast bg-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info'} text-white`;
    
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
}
</script>
{% endblock %}
